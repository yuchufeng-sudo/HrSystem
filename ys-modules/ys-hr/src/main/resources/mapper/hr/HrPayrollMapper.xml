<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ys.hr.mapper.HrPayrollMapper">

    <resultMap type="HrPayroll" id="HrPayrollResult">
        <result property="payrollId"    column="payroll_id"    />
        <result property="userId"    column="user_id"    />
        <result property="nickName"    column="nick_name"    />
        <result property="mouthDays"    column="mouth_days"    />
        <result property="presentHours"    column="present_hours"    />
        <result property="holidaysHours"    column="holidays_hours"    />
        <result property="leaveHours"    column="leave_hours"    />
        <result property="lateHours"    column="late_hours"    />
        <result property="earlyHours"    column="early_hours"    />
        <result property="overHours"    column="over_hours"    />
        <result property="absentHours"    column="absent_hours"    />
        <result property="workHours"    column="work_hours"    />
        <result property="payrollData"    column="payroll_data"    />
        <result property="baseSalary"    column="base_salary"    />
        <result property="overTimeMultiple"    column="over_time_multiple"    />
        <result property="socialSecurityCost"    column="social_security_cost"    />
        <result property="comInsuIdCost"    column="com_insu_id_cost"    />
        <result property="accuFundIdCost"    column="accu_fund_id_cost"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="remark"    column="remark"    />
        <result property="additionalCosts"    column="additional_costs"    />
        <result property="abnormalTimeMultiple"    column="abnormal_time_multiple"    />
        <result property="afterTaxSalary"    column="after_tax_salary"    />
        <result property="beforeTaxSalary"    column="before_tax_salary"    />
        <result property="payrollStatus"    column="payroll_status"    />
        <result property="overTimeCost"    column="over_time_cost"    />
        <result property="abnormalTimeCost"    column="abnormal_time_cost"    />
        <result property="hireData"    column="hire_data"    />
        <result property="presentCost"    column="present_cost"    />
        <result property="empTimeId"    column="emp_time_id"    />
    </resultMap>

    <sql id="selectHrPayrollVo">
        SELECT
            hp.payroll_id,
            hp.user_id,
            hp.mouth_days,
            hp.present_hours,
            hp.holidays_hours,
            hp.leave_hours,
            hp.late_hours,
            hp.early_hours,
            hp.over_hours,
            hp.absent_hours,
            hp.work_hours,
            hp.payroll_data,
            hp.base_salary,
            hp.over_time_multiple,
            hp.social_security_cost,
            hp.com_insu_id_cost,
            hp.accu_fund_id_cost,
            hp.create_by,
            hp.create_time,
            hp.update_by,
            hp.update_time,
            hp.remark,
            hp.additional_costs,
            hp.abnormal_time_multiple,
            hp.after_tax_salary,
            hp.before_tax_salary,
            hp.payroll_status,
            hp.over_time_cost,
            hp.abnormal_time_cost,
            hp.present_cost,
            hp.hire_data,
            hp.emp_time_id,
            he.avatar_url as avatar,
            he.full_name as fullName,
            he.employee_id,
            he.jobnumber,
            he.bank_number,
            he.bsb
        FROM
            hr_payroll hp
                left JOIN hr_employees he on he.user_id = hp.user_id
    </sql>
    <update id="updataByIds" parameterType="java.util.List">
        update hr_payroll
        set
        payroll_status = '2'
        where
        payroll_id in
        <foreach collection="list" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
    </update>


    <select id="selectHrPayrollList" parameterType="HrPayroll" resultMap="HrPayrollResult">
        <include refid="selectHrPayrollVo"/>
        <where>
            <if test="userId != null  and userId != ''"> and hp.user_id = #{userId}</if>
            <if test="nickName != null  and nickName != ''"> and hp.nick_name ILIKE concat('%', #{nickName}, '%')</if>
            <if test="mouthDays != null "> and hp.mouth_days = #{mouthDays}</if>
            <if test="presentHours != null "> and hp.present_hours = #{presentHours}</if>
            <if test="holidaysHours != null "> and hp.holidays_hours = #{holidaysHours}</if>
            <if test="leaveHours != null "> and hp.leave_hours = #{leaveHours}</if>
            <if test="lateHours != null "> and hp.late_hours = #{lateHours}</if>
            <if test="earlyHours != null "> and hp.early_hours = #{earlyHours}</if>
            <if test="overHours != null "> and hp.over_hours = #{overHours}</if>
            <if test="absentHours != null "> and hp.absent_hours = #{absentHours}</if>
            <if test="workHours != null "> and hp.work_hours = #{workHours}</if>
            <if test="payrollData != null "> and hp.payroll_data = #{payrollData}</if>
            <if test="baseSalary != null "> and hp.base_salary = #{baseSalary}</if>
            <if test="payrollStatus != null "> and hp.payroll_status = #{payrollStatus}</if>
            <if test="overTimeMultiple != null "> and hp.over_time_multiple = #{overTimeMultiple}</if>
            <if test="socialSecurityCost != null "> and hp.social_security_cost = #{socialSecurityCost}</if>
            <if test="comInsuIdCost != null "> and hp.com_insu_id_cost = #{comInsuIdCost}</if>
            <if test="accuFundIdCost != null "> and hp.accu_fund_id_cost = #{accuFundIdCost}</if>
            <if test="additionalCosts != null  and additionalCosts != ''"> and hp.additional_costs = #{additionalCosts}</if>
            <if test="abnormalTimeMultiple != null "> and hp.abnormal_time_multiple = #{abnormalTimeMultiple}</if>
            <if test="afterTaxSalary != null "> and hp.after_tax_salary = #{afterTaxSalary}</if>
            <if test="enterpriseId != null"> and hp.enterprise_id = #{enterpriseId}</if>
        </where>
    </select>

    <select id="selectHrPayrollByPayrollId" parameterType="String" resultMap="HrPayrollResult">
        <include refid="selectHrPayrollVo"/>
        where hp.payroll_id = #{payrollId}
    </select>
    <select id="getPayRollByUserId" resultType="com.ys.hr.domain.HrPayroll">
        <include refid="selectHrPayrollVo"/>
        where hp.user_id = #{userId} and hp.payroll_data = TO_TIMESTAMP(#{searchTime}, 'YYYY-MM-DD HH24:MI:SS')
    </select>
    <select id="getPayrollsCoutByHr" resultType="java.util.Map" parameterType="com.ys.hr.domain.HrAttendance">
        SELECT
        COALESCE(SUM(after_tax_salary), 0) AS total_after_tax,
        COALESCE(SUM(holidays_hours), 0) AS total_holidays,
        COALESCE(SUM(present_hours), 0) AS total_present,
        COALESCE(SUM(abnormal_time_cost), 0) AS total_abnormal
        FROM
        hr_payroll
        <where>
            <if test="enterpriseId != null  and enterpriseId != ''"> and enterprise_id = #{enterpriseId}</if>
            <if test="userId != null "> and user_id = #{userId}</if>
            <if test="params.beginCreateTime != null and params.endCreateTime != null">
                AND payroll_data BETWEEN
                TO_TIMESTAMP(#{params.beginCreateTime}, 'YYYY-MM-DD HH24:MI:SS')
                AND
                TO_TIMESTAMP(#{params.endCreateTime}, 'YYYY-MM-DD HH24:MI:SS')
            </if>
            AND payroll_status = '2'
        </where>
    </select>

    <select id="selectAnnualPayrollStatisticsList" resultType="com.ys.hr.domain.vo.AnnualPayrollStatisticsVo">
        <!-- 使用 PostgreSQL 的 extract 函数处理日期 -->
        <![CDATA[
    WITH total_before_tax AS (
        SELECT
            COALESCE(SUM(before_tax_salary), 0) AS total
        FROM hr_payroll
        WHERE
            enterprise_id = #{enterpriseId}
            AND payroll_status = '2'
            AND EXTRACT(YEAR FROM payroll_data)::INTEGER = #{year}::INTEGER
    )
    ]]>

        <!-- 第一个 CLASSIFICATION  -->
        SELECT
        'baseSalary' AS category,
        SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 1 THEN base_salary ELSE 0 END) AS jan,
        SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 2 THEN base_salary ELSE 0 END) AS feb,
        SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 3 THEN base_salary ELSE 0 END) AS mar,
        SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 4 THEN base_salary ELSE 0 END) AS apr,
        SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 5 THEN base_salary ELSE 0 END) AS may,
        SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 6 THEN base_salary ELSE 0 END) AS jun,
        SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 7 THEN base_salary ELSE 0 END) AS jul,
        SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 8 THEN base_salary ELSE 0 END) AS aug,
        SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 9 THEN base_salary ELSE 0 END) AS sep,
        SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 10 THEN base_salary ELSE 0 END) AS oct,
        SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 11 THEN base_salary ELSE 0 END) AS nov,
        SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 12 THEN base_salary ELSE 0 END) AS dec,
        -- 修正后的 Conversion 率计算（完全兼容 PostgreSQL）
        CASE
        WHEN (SELECT total FROM total_before_tax) = 0 THEN 0
        ELSE
        (ROUND( (CAST(SUM(base_salary) AS NUMERIC) * 100 / (SELECT total FROM total_before_tax)) ))::NUMERIC(10,2) / 100
        END AS conversionRate
        FROM hr_payroll
        WHERE
        enterprise_id = #{enterpriseId}
        AND payroll_status = '2'
        AND EXTRACT(YEAR FROM payroll_data)::INTEGER = #{year}::INTEGER

        <!-- 使用 UNION ALL 连接其他 CLASSIFICATION  -->
        UNION ALL

        <include refid="payrollCategory" >
            <property name="category" value="socialSecurityCost"/>
            <property name="field" value="social_security_cost"/>
        </include>

        UNION ALL
        <include refid="payrollCategory" >
            <property name="category" value="comInsuIdCost"/>
            <property name="field" value="com_insu_id_cost"/>
        </include>

        UNION ALL
        <include refid="payrollCategory" >
            <property name="category" value="accuFundIdCost"/>
            <property name="field" value="accu_fund_id_cost"/>
        </include>

        UNION ALL
        <include refid="payrollCategory" >
            <property name="category" value="additionalCosts"/>
            <property name="field" value="additional_costs"/>
        </include>

        UNION ALL
        <include refid="payrollCategory" >
            <property name="category" value="afterTaxSalary"/>
            <property name="field" value="after_tax_salary"/>
        </include>

        UNION ALL
        <include refid="payrollCategory" >
            <property name="category" value="beforeTaxSalary"/>
            <property name="field" value="before_tax_salary"/>
        </include>

        UNION ALL
        <include refid="payrollCategory" >
            <property name="category" value="overTimeCost"/>
            <property name="field" value="over_time_cost"/>
        </include>

        UNION ALL
        <include refid="payrollCategory" >
            <property name="category" value="abnormalTimeCost"/>
            <property name="field" value="abnormal_time_cost"/>
        </include>

        UNION ALL
        <include refid="payrollCategory" >
            <property name="category" value="socialSecurityCost"/>
            <property name="field" value="social_security_cost"/>
        </include>
    </select>
    <select id="selectHrPayrollListVo" resultType="com.ys.hr.domain.vo.payRollVo">
        <include refid="selectHrPayrollVo"/>
        <where>
            <if test="userId != null  and userId != ''"> and hp.user_id = #{userId}</if>
            <if test="nickName != null  and nickName != ''"> and hp.nick_name ILIKE concat('%', #{nickName}, '%')</if>
            <if test="mouthDays != null "> and hp.mouth_days = #{mouthDays}</if>
            <if test="presentHours != null "> and hp.present_hours = #{presentHours}</if>
            <if test="holidaysHours != null "> and hp.holidays_hours = #{holidaysHours}</if>
            <if test="leaveHours != null "> and hp.leave_hours = #{leaveHours}</if>
            <if test="lateHours != null "> and hp.late_hours = #{lateHours}</if>
            <if test="earlyHours != null "> and hp.early_hours = #{earlyHours}</if>
            <if test="overHours != null "> and hp.over_hours = #{overHours}</if>
            <if test="absentHours != null "> and hp.absent_hours = #{absentHours}</if>
            <if test="workHours != null "> and hp.work_hours = #{workHours}</if>
            <if test="payrollData != null "> and hp.payroll_data = #{payrollData}</if>
            <if test="baseSalary != null "> and hp.base_salary = #{baseSalary}</if>
            <if test="overTimeMultiple != null "> and hp.over_time_multiple = #{overTimeMultiple}</if>
            <if test="socialSecurityCost != null "> and hp.social_security_cost = #{socialSecurityCost}</if>
            <if test="comInsuIdCost != null "> and hp.com_insu_id_cost = #{comInsuIdCost}</if>
            <if test="accuFundIdCost != null "> and hp.accu_fund_id_cost = #{accuFundIdCost}</if>
            <if test="additionalCosts != null  and additionalCosts != ''"> and hp.additional_costs = #{additionalCosts}</if>
            <if test="abnormalTimeMultiple != null "> and hp.abnormal_time_multiple = #{abnormalTimeMultiple}</if>
            <if test="afterTaxSalary != null "> and hp.after_tax_salary = #{afterTaxSalary}</if>
        </where>
    </select>
    <select id="selectHrPayrollListVoByIds" resultType="com.ys.hr.domain.vo.payRollVo">
        <include refid="selectHrPayrollVo"/>
        WHERE hp.payroll_id IN
        <foreach item="id" collection="payrollIds.split(',')" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="lastPayrollByUserId" resultType="com.ys.hr.domain.HrPayroll"
            parameterType="com.ys.hr.domain.HrPayroll">
        SELECT
            hp.payroll_id,
            hp.hire_data
        FROM hr_payroll hp
        WHERE hp.user_id = #{userId}
        ORDER BY hp.payroll_data DESC
            LIMIT 1;
    </select>

    <!-- MODIFY后的 PostgreSQL 兼容模板 -->
    <sql id="payrollCategory">
        SELECT
            #{category} AS category,
            SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 1 THEN ${field} ELSE 0 END) AS jan,
            SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 2 THEN ${field} ELSE 0 END) AS feb,
            SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 3 THEN ${field} ELSE 0 END) AS mar,
            SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 4 THEN ${field} ELSE 0 END) AS apr,
            SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 5 THEN ${field} ELSE 0 END) AS may,
            SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 6 THEN ${field} ELSE 0 END) AS jun,
            SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 7 THEN ${field} ELSE 0 END) AS jul,
            SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 8 THEN ${field} ELSE 0 END) AS aug,
            SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 9 THEN ${field} ELSE 0 END) AS sep,
            SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 10 THEN ${field} ELSE 0 END) AS oct,
            SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 11 THEN ${field} ELSE 0 END) AS nov,
            SUM(CASE WHEN EXTRACT(MONTH FROM payroll_data) = 12 THEN ${field} ELSE 0 END) AS dec,
        -- 简化并修正 Conversion 率计算
        CASE
            WHEN (SELECT total FROM total_before_tax) = 0 THEN 0
            ELSE
                (ROUND( (CAST(SUM(
                <if test="filed == 'social_security_cost'">social_security_cost</if>
                <if test="filed == 'com_insu_id_cost'">com_insu_id_cost</if>
                <if test="filed == 'accu_fund_id_cost'">accu_fund_id_cost</if>
                <if test="filed == 'additional_costs'">additional_costs</if>
                <if test="filed == 'after_tax_salary'">after_tax_salary</if>
                <if test="filed == 'before_tax_salary'">before_tax_salary</if>
                <if test="filed == 'over_time_cost'">over_time_cost</if>
                <if test="filed == 'abnormal_time_cost'">abnormal_time_cost</if>
                <if test="filed == 'social_security_cost'">social_security_cost</if>
                ) AS NUMERIC) * 100 / (SELECT total FROM total_before_tax)) ))::NUMERIC(10,2) / 100
        END AS conversionRate
    FROM hr_payroll
    WHERE
        enterprise_id = #{enterpriseId}
        AND payroll_status = '2'
        AND EXTRACT(YEAR FROM payroll_data)::INTEGER = #{year}::INTEGER
    </sql>


</mapper>
